# Feature Specification: ツリー全展開/全折り畳み

**Feature Branch**: `001-tree-expand-collapse`  
**Created**: 2025-09-05  
**Status**: Draft  
**Input**: User description: "viewのツリーの全展開、全折り畳みアイコンをプロジェクト一覧、チケット一覧に追加する。ツリーの展開状態は記録しておく"

## Clarifications

### Session 2025-09-05

- Q: 展開状態の記録範囲はどこまでか？ → A: ワークスペース内で永続保持（再起動後も復元）
- Q: フィルタ/検索時の全展開/全折り畳み対象範囲は？ → A: 現在表示中（フィルタ結果）のノードのみ対象
- Q: 展開状態の復元に使うノード識別キーは？ → A: 既存の一意ID（例: プロジェクトID/チケットID）
- Q: フィルタ/検索条件が変わった場合の展開状態の粒度は？ → A: 一覧ごとに1つの状態を共有（フィルタ条件に関係なく同じ記録を使う）
- Q: 展開状態の記録上限は？ → A: 1一覧あたり最大5,000ノードまで記録

## User Scenarios & Testing *(mandatory)*

**Constitution reminder**: Unit tests are mandatory and must be defined before
implementation. Ensure scenarios can be covered by unit tests.

### User Story 1 - プロジェクト一覧の一括展開/折り畳み (Priority: P1)

ユーザーはプロジェクト一覧のツリーを一括で展開または折り畳みできる。

**Why this priority**: 大量の階層を素早く把握・整理できるため、最も価値が高い。

**Independent Test**: プロジェクト一覧で一括展開/折り畳みを実行し、全ノードの状態が期待通りになることを確認できる。

**Acceptance Scenarios**:

1. **Given** プロジェクト一覧に複数階層のノードがある, **When** 全展開アイコンを選択する, **Then** 表示可能な全ノードが展開される
2. **Given** プロジェクト一覧に複数階層のノードがある, **When** 全折り畳みアイコンを選択する, **Then** 表示可能な全ノードが折り畳まれる

---

### User Story 2 - チケット一覧の一括展開/折り畳み (Priority: P2)

ユーザーはチケット一覧のツリーを一括で展開または折り畳みできる。

**Why this priority**: チケットの階層確認を高速化し、同様の操作体験を提供する。

**Independent Test**: チケット一覧で一括展開/折り畳みを実行し、全ノードの状態が期待通りになることを確認できる。

**Acceptance Scenarios**:

1. **Given** チケット一覧に複数階層のノードがある, **When** 全展開アイコンを選択する, **Then** 表示可能な全ノードが展開される
2. **Given** チケット一覧に複数階層のノードがある, **When** 全折り畳みアイコンを選択する, **Then** 表示可能な全ノードが折り畳まれる

---

### User Story 3 - 展開状態の復元 (Priority: P3)

ユーザーは一覧ビューを離れて戻っても、前回の展開状態が保たれる。

**Why this priority**: 作業途中の文脈を維持でき、再操作の手間を減らせる。

**Independent Test**: 一覧で任意の展開状態を作り、ビューを切り替えて戻った際に同じ状態が再現されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 任意の展開状態のプロジェクト一覧がある, **When** 別のビューに切り替えてから戻る, **Then** 前回の展開状態が復元される
2. **Given** 任意の展開状態のチケット一覧がある, **When** 別のビューに切り替えてから戻る, **Then** 前回の展開状態が復元される

---

### Edge Cases

- 何も表示されない空の一覧で一括展開/折り畳みを実行した場合は、状態が変化しない
- 一括操作後に個別ノードを展開/折り畳みした場合は、その変更が記録される
- 一覧の内容が更新され既存ノードが消えた場合は、残っているノードのみ状態を復元する
- 新規に追加されたノードは既定で折り畳まれる

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはプロジェクト一覧に「全展開」「全折り畳み」の操作を提供しなければならない
- **FR-002**: システムはチケット一覧に「全展開」「全折り畳み」の操作を提供しなければならない
- **FR-003**: 全展開は表示可能な全ノードを展開しなければならない
- **FR-004**: 全折り畳みは表示可能な全ノードを折り畳まなければならない
- **FR-005**: システムは一覧ごとに展開状態を記録し、ワークスペース内で再起動後も同一の一覧に戻った際に復元しなければならない
- **FR-006**: ユーザーが個別に展開/折り畳みを行った場合、その変更が記録に反映されなければならない
- **FR-007**: 一覧の内容が更新された場合、同一識別子のノードは直前の展開状態を復元し、新規ノードは折り畳みとしなければならない
- **FR-008**: フィルタ/検索が適用されている場合、全展開/全折り畳みは現在表示中のノードのみに作用しなければならない
- **FR-009**: 展開状態の復元は既存の一意IDをノード識別キーとして用いなければならない
- **FR-010**: 展開状態は一覧ごとに1つで管理し、フィルタ/検索条件によって分けてはならない
- **FR-011**: 展開状態の記録は1一覧あたり最大5,000ノードまでとしなければならない

### Key Entities *(include if feature involves data)*

- **ツリー展開状態**: 一覧種別ごとのノードの展開/折り畳み状態を表す情報
- **ツリーノード**: プロジェクトまたはチケットの階層項目
- **ノード識別キー**: 既存の一意ID（プロジェクトID/チケットID）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは全展開/全折り畳み操作を3秒以内に完了できる
- **SC-002**: ビュー切り替え後の復元で、以前の展開状態が90%以上のケースで一致する
- **SC-003**: 一覧の全ノードが期待通りの状態になることを、主要なシナリオで100%確認できる
- **SC-004**: 全展開/全折り畳み機能に関するサポート問い合わせがリリース前後で増加しない
- **SC-005**: 5,000ノード規模の一覧で、全展開/全折り畳み操作が5秒以内に完了する

## Assumptions

- 展開状態の復元は同一ワークスペース内で再起動後も適用される
- 新規追加ノードは既定で折り畳まれる
