# Feature Specification: メタデータ先頭配置

**Feature Branch**: `001-metadata-before-subject`  
**Created**: 2025-12-28  
**Status**: Draft  
**Input**: User description: "エディタのメタデータの位置を変更する。現状は先頭に#で件名を定義しているがメタデータをはじめに持ってきて、そのあとに件名の定義をするようにする。"

## Clarifications

### Session 2025-12-28

- Q: 旧形式を読み込んだ後、保存時にどちらの形式で出力するか？ → A: 読み込んだ形式を保持して保存（旧形式は旧形式のまま）
- Q: メタデータの「先頭」は空行/コメントを含めずファイル先頭か？ → A: 空行やコメントを含めず、ファイル先頭に配置
- Q: 本文（件名後）にある空行の扱いは？ → A: 既存の空行は保持（本文は変更しない）
- Q: 旧形式でメタデータがない本文はどう保存するか？ → A: メタデータを追加せず、そのまま保存
- Q: 件名の書式は `# ` で始まる1行のみか？ → A: `# ` で始まる1行のみを件名として扱う

## User Scenarios & Testing *(mandatory)*

**Constitution reminder**: Unit tests are mandatory and must be defined before
implementation. Ensure scenarios can be covered by unit tests.

### User Story 1 - 先頭にメタデータを配置できる (Priority: P1)

ユーザーはチケット編集用のエディタで、メタデータブロックが本文の先頭に配置された形式を利用できる。

**Why this priority**: メタデータの視認性と編集効率が最優先であり、これが主目的の変更であるため。

**Independent Test**: 既存のチケット本文を読み込み、メタデータが先頭に表示され、件名がその直後に表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** メタデータと件名を含むチケット本文がある, **When** エディタに表示する, **Then** メタデータが最初に表示され件名がその直後に続く
2. **Given** 新規チケットの編集を開始する, **When** エディタ本文が生成される, **Then** メタデータが先頭に生成され件名はその後に生成される

---

### User Story 2 - 既存形式の読み取り互換 (Priority: P2)

ユーザーは従来の件名先頭形式の本文でも、メタデータと件名が正しく読み取られる。

**Why this priority**: 過去のデータを安全に扱うために互換性が必要。

**Independent Test**: 旧形式（件名が先頭）を読み込んだ際に、メタデータと件名が正しく抽出されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 件名が先頭にある旧形式の本文がある, **When** エディタに読み込む, **Then** メタデータと件名が正しく解析される

---

### User Story 3 - 保存時の整形規則維持 (Priority: P3)

ユーザーは編集後に保存しても、メタデータ先頭・件名後続の順序が維持される。

**Why this priority**: 保存による再整形で順序が崩れると混乱が起きるため。

**Independent Test**: 編集→保存→再読込の流れで順序が維持されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** 編集済みの本文がある, **When** 保存して再読込する, **Then** メタデータが先頭で件名が直後に並ぶ

---

### Edge Cases

- メタデータが空の場合でも件名が先頭に来ない
- 旧形式の本文にメタデータが存在しない場合は件名のみを表示する
- メタデータと件名の間に空行が複数ある場合でも順序は保持される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはエディタ本文生成時にメタデータを先頭に配置しなければならない
- **FR-002**: システムはメタデータ直後に件名行を配置しなければならない
- **FR-003**: システムは旧形式（件名先頭）を読み込んだ際にメタデータと件名を正しく抽出しなければならない
- **FR-004**: システムは保存時に読み込んだ形式を保持し、旧形式は旧形式のまま保存しなければならない
- **FR-005**: メタデータが空の場合でも、件名行の位置はメタデータブロック後に配置しなければならない
- **FR-006**: メタデータは空行やコメントを含めずファイル先頭に配置しなければならない
- **FR-007**: 本文（件名後）にある空行は保存時に正規化せず保持しなければならない
- **FR-008**: 旧形式でメタデータがない場合は、メタデータを追加せずそのまま保存しなければならない
- **FR-009**: 件名は `# ` で始まる1行のみを対象として扱わなければならない

### Key Entities *(include if feature involves data)*

- **メタデータブロック**: 件名以外の属性情報をまとめた領域
- **件名行**: `#` で始まる件名の定義行
- **エディタ本文**: メタデータ・件名・本文を含む編集用テキスト

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 既存の本文を読み込んだ際、メタデータと件名の位置が期待通りに再構成される割合が95%以上
- **SC-002**: 新規本文の生成でメタデータが先頭に配置される割合が100%
- **SC-003**: 保存→再読込後に順序が維持される割合が100%
- **SC-004**: 旧形式の読み取りでメタデータ抽出失敗が1%未満

## Assumptions

- 件名は `#` で始まる単一行として扱う
- メタデータは本文の最上部に存在するブロックとして扱う
