# Feature Specification: Comment Save Rename

**Feature Branch**: `001-comment-save-rename`  
**Created**: 2025-12-29  
**Status**: Draft  
**Input**: User description: "新規コメント追加時の処理を変更する。新規コメントをエディタで編集して保存した後はエディタで開いたファイル名を変更してコメント更新ようのファイル名に変更する。これによってコメント追加用エディタで保存された後はそのコメントの編集をする動作にする。"

## User Scenarios & Testing *(mandatory)*

**Constitution reminder**: Unit tests are mandatory and must be defined before
implementation. Ensure scenarios can be covered by unit tests.

### User Story 1 - 新規コメント保存後に継続編集できる (Priority: P1)

ユーザーとして、新規コメントを保存したあと同じエディタで続けて内容を直せるようにしたい。そうすれば、保存後の細かな修正でも同じコメントを更新できる。

**Why this priority**: 新規コメントの追記や修正は最も頻度の高い作業であり、保存後に別操作が必要だと編集の流れが途切れるため。

**Independent Test**: 新規コメントを保存するとエディタが更新モードに切り替わり、次の保存が同じコメントの更新になることを確認できる。

**Acceptance Scenarios**:

1. **Given** 新規コメント追加用のエディタが開いている, **When** コメントを保存して新規コメントが作成される, **Then** エディタが更新モードに切り替わる（ファイル名は変更しない）。
2. **Given** 直前に新規コメントが保存されている, **When** そのエディタで再度保存する, **Then** 新しいコメントではなく同じコメントが更新される。

---

### User Story 2 - 失敗時は追加モードのまま再試行できる (Priority: P2)

ユーザーとして、保存に失敗した場合は追加モードのまま内容を見直して再試行したい。そうすれば誤って更新モードに切り替わらず、意図しない動作を避けられる。

**Why this priority**: 失敗時の挙動が不安定だと重複投稿や編集ミスにつながるため。

**Independent Test**: 保存失敗後、追加モードのまま再保存できることを確認できる。

**Acceptance Scenarios**:

1. **Given** 新規コメント追加の保存が失敗する, **When** エディタを確認する, **Then** 追加モードのままである。
2. **Given** 保存失敗後に再度保存する, **When** 正常に保存される, **Then** その時点で更新用のファイル名に切り替わる。

---

### Edge Cases

- コメント識別子が取得できない場合は追加モードを維持し、識別子取得失敗を通知して再試行できるようにする。
- 保存完了直後にエディタが閉じられた場合でも、更新モードへの切り替えはバックグラウンドで完了し通知のみ行う。
- 複数の新規コメント追加エディタが同時に開いている場合は、保存対象のエディタのみ切り替える。
- 新規コメント作成後もファイル名は変更せず、同一ドキュメントのまま更新モードに切り替える。

### Out of Scope

- コメント本文の入力体験やバリデーションの見直し
- コメント権限や認可の変更

## Clarifications

### Session 2025-12-29

- Q: コメント保存は成功したが、更新用に必要なコメント識別子が取得できなかった場合の扱いは? → A: 追加モードのまま維持し、識別子取得失敗を通知して再試行を促す。
- Q: 保存完了直後にエディタが閉じられた場合、更新モードへの切り替えはどう扱う? → A: バックグラウンドで切り替えを完了し、通知のみ行う。
- Q: 複数の新規コメント追加エディタが同時に開いている場合、切り替え対象の判定方法は? → A: 保存処理の対象エディタのみを切り替える（保存イベント起点で特定）。
- Q: 新規コメント保存後のファイル名切り替えは必要か? → A: 不要。ファイル名は変更せず更新モードに切り替える。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST 新規コメントの保存が成功した直後に、対象エディタを更新モードに切り替える（ファイル名は変更しない）。
- **FR-002**: System MUST ファイル名の切り替え後、同じエディタの次回保存が同一コメントの更新として扱われるようにする。
- **FR-003**: System MUST 新規コメントの保存が失敗した場合、追加モードのままにする。
- **FR-003a**: System MUST コメント識別子が取得できない場合、追加モードを維持し識別子取得失敗を通知して再試行できるようにする。
- **FR-004**: System MUST 複数の新規コメント追加エディタが開いている場合でも、保存対象のエディタのみを更新モードに切り替える。
- **FR-004a**: System MUST 保存完了直後にエディタが閉じられていても、更新モードへの切り替えを完了し通知のみ行う。
- **FR-005**: System MUST 更新モードへの切り替えによってエディタ内容が失われないようにする。
- **FR-006**: System MUST 新規コメント保存後の更新判定はコメント識別子に基づいて行う。

### Key Entities *(include if feature involves data)*

- **新規コメント**: 新しく作成されるコメント。
- **更新対象コメント**: 新規保存後に編集対象として扱うコメント。
- **コメント追加エディタ**: 新規コメント追加用のエディタ。
- **コメント更新用ファイル名**: 既存コメント編集時に使用するファイル名（プロジェクトID、チケットID、コメントID、コメント種別ラベル「comment」を含む）。

### Assumptions

- 新規コメント保存時に更新対象として使えるコメント識別子が取得できる。
- コメント保存の成否はユーザーに明確に通知される。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 新規コメントの保存が成功したケースの100%で、2秒以内にエディタが更新モードに切り替わる。
- **SC-002**: 保存後の再保存で同一コメントが更新される成功率が95%以上である。
- **SC-003**: 保存失敗時に誤って更新モードへ移行した報告が0件である。
