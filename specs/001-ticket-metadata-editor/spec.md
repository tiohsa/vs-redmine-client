# Feature Specification: チケットメタデータ表示・更新

**Feature Branch**: `001-ticket-metadata-editor`  
**Created**: 2025-12-27  
**Status**: Draft  
**Input**: User description: "エディタにチケットのメタデータを---から---の間の行に表示する。メタデータを変更するとチケット更新時にその内容で更新する"

## Clarifications

### Session 2025-12-27

- Q: `---` の区切りが無い場合の扱い → A: エディタ表示時にメタデータブロックを自動挿入する
- Q: メタデータ区間が空のままの場合の扱い → A: 不正として扱い、更新時にエラーにする
- Q: メタデータ項目が重複する場合の扱い → A: 不正として扱い、更新時にエラーにする
- Q: YAML として解釈できない行の扱い → A: 不正として扱い、更新時にエラーにする
- Q: YAML のキー/値の前後空白の扱い → A: 許容し、値は YAML の解釈結果を採用する
- Q: tracker/priority/status の値形式 → A: 表示名（文字列）で指定する
- Q: issue 配下の構造制限 → A: issue 構造のみ許可し、他のネストや配列は不正とする
- Q: due_date の形式 → A: YYYY-MM-DD のみ許可し、未指定（空）も許容する
- Q: 必須項目の空値の扱い → A: 不正として扱い、更新時にエラーにする
- Q: メタデータ内のキー重複 → A: 不正として扱い、更新時にエラーにする

## User Scenarios & Testing *(mandatory)*

**Constitution reminder**: Unit tests are mandatory and must be defined before
implementation. Ensure scenarios can be covered by unit tests.

### User Story 1 - メタデータを確認する (Priority: P1)

チケットを編集中の担当者として、本文と同じエディタ内でメタデータを確認したい。これにより、別の画面へ移動せずに内容の全体像を把握できる。

**Why this priority**: 編集作業の前提となる情報を同じ場所で把握できることが最優先の価値だから。

**Independent Test**: 既存チケットを開き、本文の指定区間にメタデータが表示されることだけを確認すれば成立する。

**Acceptance Scenarios**:

1. **Given** 既存チケットをエディタで開いている, **When** エディタ内容が表示される, **Then** `---` から `---` の間の行にチケットのメタデータが表示される
2. **Given** エディタ内の本文をスクロールしている, **When** メタデータ区間が表示される, **Then** メタデータが本文と同じエディタ内で読み取れる

---

### User Story 2 - メタデータを編集して更新する (Priority: P2)

チケットを更新する担当者として、エディタ内のメタデータを修正し、その内容でチケットを更新したい。これにより、更新作業が一箇所で完結する。

**Why this priority**: 確認だけでなく更新まで一貫して行えることが実用上重要だから。

**Independent Test**: メタデータ区間を書き換え、更新操作を行い、更新結果に反映されるかを確認すれば成立する。

**Acceptance Scenarios**:

1. **Given** メタデータ区間が表示されている, **When** メタデータの値を変更してチケット更新を実行する, **Then** 更新結果に変更後のメタデータが反映される
2. **Given** メタデータ以外の本文を変更していない, **When** メタデータだけを変更して更新する, **Then** 本文は変更されずメタデータのみ更新される

---

### User Story 3 - 形式不備を検知する (Priority: P3)

チケットを更新する担当者として、メタデータの形式が不正な場合は更新が失敗したことを理解したい。これにより、誤った内容で更新されることを防げる。

**Why this priority**: 誤更新を防ぐための保護は重要だが、表示・更新よりは優先度が低い。

**Independent Test**: メタデータの形式を崩し、更新時にエラーが提示されることだけを確認すれば成立する。

**Acceptance Scenarios**:

1. **Given** メタデータ区間の形式が要件に合っていない, **When** チケット更新を実行する, **Then** 更新は行われず不備が分かる通知が表示される

---

### Edge Cases

- `---` の区切りが存在しない場合は、表示時にメタデータブロックを自動挿入する
- メタデータ区間が空のままの場合は不正として扱い、更新時にエラーとする
- 同じ項目が重複している場合は不正として扱い、更新時にエラーとする
- YAML として解釈できない行が含まれる場合は不正として扱い、更新時にエラーとする
- YAML のキー/値の前後空白は許容し、値は YAML の解釈結果を採用する
- 必須項目（tracker/priority/status）が欠けている場合は不正として扱い、更新時にエラーとする
- issue ブロック以外のトップレベルキーが含まれる場合は不正として扱い、更新時にエラーとする

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: エディタはチケットのメタデータを `---` から `---` の間の行に表示しなければならない
- **FR-002**: メタデータ区間の内容は、チケット更新時に更新対象として扱われなければならない
- **FR-003**: メタデータ区間に変更がある場合、更新結果に変更後の値が反映されなければならない
- **FR-004**: メタデータは YAML 形式で表現されなければならない
- **FR-005**: メタデータ区間の形式が要件に合っていない場合、更新は行われず不備が通知されなければならない
- **FR-006**: メタデータ区間以外の本文は、メタデータ更新のみの場合に変更されてはならない
- **FR-007**: `---` の区切りが存在しない場合、エディタ表示時にメタデータブロックを自動挿入しなければならない
- **FR-008**: メタデータ区間が空のままの場合、更新は行われず不備が通知されなければならない
- **FR-009**: メタデータ項目が重複する場合、更新は行われず不備が通知されなければならない
- **FR-010**: メタデータは `issue` をトップレベルキーとして持たなければならない
- **FR-011**: `issue` 配下には `tracker`、`priority`、`status`、`due_date` の項目が含まれなければならない
- **FR-012**: `issue` ブロック以外のトップレベルキーが含まれる場合、更新は行われず不備が通知されなければならない
- **FR-013**: `tracker`、`priority`、`status` が欠けている場合、更新は行われず不備が通知されなければならない
- **FR-014**: `tracker`、`priority`、`status` の値は表示名（文字列）で指定されなければならない
- **FR-015**: `issue` 配下は `tracker`、`priority`、`status`、`due_date` のみを持ち、他のネストや配列が含まれる場合は更新を行わず不備を通知しなければならない
- **FR-016**: `due_date` は `YYYY-MM-DD` 形式のみ許可し、未指定（空）も許容されなければならない
- **FR-017**: `tracker`、`priority`、`status` が空の場合、更新は行われず不備が通知されなければならない

### Metadata Format

メタデータは次の YAML 形式とする。

```yaml
issue:
  tracker:   [トラッカー名]      # 例: Task
  priority:  [優先度名]          # 例: Normal
  status:    [ステータス名]      # 例: In Progress
  due_date:  [期日]          # 例: 2025-12-31
```

### Key Entities *(include if feature involves data)*

- **チケット**: 本文とメタデータを持つ作業対象
- **メタデータ**: チケットに付随する属性情報（YAML の `issue` ブロックで表現される項目名と値の組）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 既存チケットを開いたユーザーの95%が、メタデータをエディタ内で確認できたと回答する
- **SC-002**: メタデータのみの更新操作が3分以内に完了する割合が95%以上になる
- **SC-003**: メタデータ形式の不備を含む更新の100%が反映前に検知される
- **SC-004**: メタデータ更新後のチケット内容確認で、本文が意図せず変わった事例が0件である

## Assumptions

- メタデータは既存のチケット属性を表し、新規項目の追加は対象外とする
- メタデータは項目名と値の組で表現され、表示順は既存の並びに準拠する
- 外部依存関係の追加は行わない
