# Feature Specification: コメント画像アップロード

**Feature Branch**: `001-comment-image-upload`  
**Created**: 2025-12-26  
**Status**: Draft  
**Input**: User description: "コメントに画像リンクを付けたときに保存しても画像がアップロードされていない。チケットの編集と同じ仕様にして画像アップロードできるようにする"

## Clarifications

### Session 2025-12-26

- Q: 画像アップロードが失敗した場合のコメント保存の扱いはどうするか？ → A: 画像アップロードが1つでも失敗したらコメント保存を失敗させる
- Q: 画像の閲覧権限はどうするか？ → A: 既存の閲覧権限ルールに従う（コメント閲覧できるユーザーのみ表示）
- Q: コメント内の画像アップロード対象判定はどうするか？ → A: チケット編集時と同等の対象判定（拡張子・形式・サイズなど既存基準）
- Q: コメント編集で画像リンクを削除した場合の既存画像の扱いはどうするか？ → A: チケット編集時の削除/保持ルールに合わせる
- Q: コメント保存時の画像アップロード再評価のタイミングはどうするか？ → A: コメント保存のたびに画像リンクを再評価し、必要なアップロードを行う

## User Scenarios & Testing *(mandatory)*

**Constitution reminder**: Unit tests are mandatory and must be defined before
implementation. Ensure scenarios can be covered by unit tests.

### User Story 1 - コメント保存で画像が利用可能 (Priority: P1)

ユーザーはコメントに画像リンクを含めて保存すると、画像がアップロードされ、閲覧時に画像が表示できる。

**Why this priority**: コメントは日常的に使われ、画像が表示されないと作業が止まるため最優先。

**Independent Test**: 画像リンクを含むコメントを保存し、保存直後に画像が表示できることを確認すれば価値が成立。

**Acceptance Scenarios**:

1. **Given** 画像リンクを含む新規コメントがある, **When** 保存する, **Then** 画像がアップロードされ閲覧で表示できる
2. **Given** 画像リンクを含む新規コメントがある, **When** 保存に成功する, **Then** 画像の参照先が有効である

---

### User Story 2 - コメント編集で画像が更新される (Priority: P2)

ユーザーは既存コメントを編集して画像リンクを追加・変更しても、保存後に正しく画像が利用できる。

**Why this priority**: 編集時の一貫性がないと、再編集による回避ができず作業が中断されるため。

**Independent Test**: 既存コメントに画像リンクを追加して保存し、画像が表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 画像リンクを含まない既存コメントがある, **When** 画像リンクを追加して保存する, **Then** 画像がアップロードされ表示できる

---

### User Story 3 - 既存の画像リンクが影響を受けない (Priority: P3)

ユーザーは画像リンクを含まないコメントを保存しても、余計な変更やエラーが発生しない。

**Why this priority**: 画像を使わない通常のコメントが影響を受けると広範囲に影響するため。

**Independent Test**: 画像リンクを含まないコメントを保存し、保存結果が変わらないことを確認できる。

**Acceptance Scenarios**:

1. **Given** 画像リンクを含まないコメントがある, **When** 保存する, **Then** 既存の保存結果と同じである

---

### Edge Cases

- 画像リンクが無効・壊れている場合、コメント保存は失敗しユーザーに失敗が示される
- 同じコメント内に複数の画像リンクがある場合、すべてがアップロードされる
- 画像以外のリンクが含まれる場合、アップロード対象にならない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはコメント保存時に画像リンクを検出し、画像をアップロードできること
- **FR-002**: システムはチケット編集時と同等の基準で画像リンクを処理すること（対象判定は拡張子・形式・サイズなど既存基準に準拠）
- **FR-003**: ユーザーはコメント保存後に画像が表示されることを確認できること
- **FR-004**: 画像リンクのアップロードが1つでも失敗した場合、コメント保存は失敗となりユーザーに失敗が分かる結果を返すこと
- **FR-005**: 画像リンクを含まないコメントの保存は従来と同じ結果であること
- **FR-006**: コメント保存のたびに画像リンクを再評価し、必要な画像アップロードを実行すること

### Key Entities *(include if feature involves data)*

- **コメント**: チケットに紐づくユーザーの書き込み。本文と添付に関する参照情報を持つ
- **画像リンク**: コメント本文内に含まれる画像参照。アップロード対象の識別に使う
- **画像アップロード結果**: アップロードの成否と参照先情報

## Scope

- コメント保存・編集時の画像リンクのアップロード処理
- コメント本文内の画像リンクのみを対象とする
- コメント以外の領域（チケット本文・説明など）は対象外

## Dependencies

- チケット編集時の画像アップロード仕様と保存先
- 画像の閲覧権限とアクセス制御の既存ルール（コメント閲覧権限に準拠）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 画像リンクを含むコメントの保存後、95% 以上で画像が表示できる
- **SC-002**: 画像リンクを含むコメント保存の完了が 10 秒以内である
- **SC-003**: 画像リンクを含まないコメント保存の失敗率が 1% 未満である
- **SC-004**: コメントの画像アップロード不具合に関する問い合わせが 50% 以上減少する

## Assumptions

- 画像リンクの対象・拡張子の扱いは、既存のチケット編集時の仕様と同一である
- 画像の保存先とアクセス可能期間は既存仕様に従う
